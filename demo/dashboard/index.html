<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goal Portfolio Viewer - E2E Dashboard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 0;
            background: #f3f4f6;
        }

        .demo-shell {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .demo-card {
            background: #ffffff;
            padding: 32px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            max-width: 520px;
            text-align: center;
        }

        .demo-card h1 {
            margin: 0 0 8px;
            color: #111827;
            font-size: 28px;
        }

        .demo-card p {
            margin: 0;
            color: #4b5563;
        }

        .demo-status {
            margin-top: 20px;
            padding: 12px 16px;
            border-radius: 8px;
            background: #eef2ff;
            color: #3730a3;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="demo-shell">
        <div class="demo-card">
            <h1>Goal Portfolio Viewer</h1>
            <p>Mock Endowus dashboard for E2E tests.</p>
            <div class="demo-status" id="demoStatus">Loading demo dataâ€¦</div>
        </div>
    </div>

    <script>
        window.__GPV_DEMO_MODE__ = true;
    </script>

    <script>
        const mockStorage = {};

        window.GM_setValue = function(key, value) {
            mockStorage[key] = value;
        };

        window.GM_getValue = function(key, defaultValue) {
            return Object.prototype.hasOwnProperty.call(mockStorage, key) ? mockStorage[key] : defaultValue;
        };

        window.GM_deleteValue = function(key) {
            delete mockStorage[key];
        };

        window.GM_cookie = undefined;
    </script>

    <script>
        (function() {
            const PERFORMANCE_ENDPOINT = 'https://bff.prod.silver.endowus.com/v1/performance';
            const originalFetch = window.fetch.bind(window);

            window.fetch = function(resource, options) {
                const url = typeof resource === 'string' ? resource : resource?.url;
                if (url && url.startsWith(PERFORMANCE_ENDPOINT)) {
                    const originalUrl = new URL(url);
                    const localUrl = new URL('/v1/performance', window.location.origin);
                    originalUrl.searchParams.forEach((value, key) => {
                        localUrl.searchParams.set(key, value);
                    });
                    if (resource instanceof Request) {
                        resource = new Request(localUrl.toString(), resource);
                    } else {
                        resource = localUrl.toString();
                    }
                }
                return originalFetch(resource, options);
            };
        })();
    </script>

    <script>
        function updateStatus(message, isError = false) {
            const status = document.getElementById('demoStatus');
            status.textContent = message;
            if (isError) {
                status.style.background = '#fee2e2';
                status.style.color = '#991b1b';
            } else {
                status.style.background = '#ecfdf3';
                status.style.color = '#065f46';
            }
        }

        function loadUserscript() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = '/tampermonkey/goal_portfolio_viewer.user.js';
                script.onload = () => resolve();
                script.onerror = () => reject(new Error('Failed to load userscript'));
                document.head.appendChild(script);
            });
        }

        function waitForSyncUiExports() {
            return new Promise(resolve => {
                const check = () => {
                    if (window.__gpvSyncUi?.createSyncSettingsHTML && window.__gpvSyncUi?.createConflictDialogHTML) {
                        resolve();
                        return;
                    }
                    setTimeout(check, 50);
                };
                check();
            });
        }

        async function bootstrapMockData() {
            const responses = await Promise.all([
                fetch('/v1/goals/performance'),
                fetch('/v2/goals/investible'),
                fetch('/v1/goals')
            ]);
            const payloads = await Promise.all(responses.map(response => response.json()));
            const investible = payloads[1];
            const fixedGoalId = Array.isArray(investible)
                ? investible.find(goal => goal && goal.goalName && goal.goalName.startsWith('House Purchase'))?.goalId
                : null;
            if (fixedGoalId) {
                GM_setValue(`goal_fixed_${fixedGoalId}`, true);
            }
            return payloads;
        }

        function waitForButton() {
            return new Promise(resolve => {
                const check = () => {
                    if (document.querySelector('.gpv-trigger-btn')) {
                        resolve();
                        return;
                    }
                    setTimeout(check, 100);
                };
                check();
            });
        }

        function signalReady() {
            window.__GPV_E2E_READY__ = true;
            window.dispatchEvent(new Event('gpv:e2e-ready'));
        }

        loadUserscript()
            .then(bootstrapMockData)
            .then(waitForButton)
            .then(waitForSyncUiExports)
            .then(() => {
                updateStatus('Demo data loaded. Ready for E2E tests.');
                signalReady();
            })
            .catch(error => {
                console.error('[Demo] Failed to initialize E2E demo:', error);
                updateStatus('Failed to initialize demo environment.', true);
            });
    </script>
</body>
</html>
